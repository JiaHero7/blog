<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/uploads/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/uploads/favicon.ico">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"dunwu.github.io","root":"/blog/","images":"/blog/images","scheme":"Pisces","darkmode":true,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/blog/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/blog/js/config.js"></script>

    <meta name="description" content="钝悟的个人博客">
<meta property="og:type" content="website">
<meta property="og:title" content="Dunwu Blog">
<meta property="og:url" content="https://dunwu.github.io/blog/page/15/index.html">
<meta property="og:site_name" content="Dunwu Blog">
<meta property="og:description" content="钝悟的个人博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="钝悟 ◾ Dunwu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://dunwu.github.io/blog/page/15/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/15/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Dunwu Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Dunwu Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">大道至简，知易行难</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">122</span></a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">40</span></a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">144</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="钝悟 ◾ Dunwu"
      src="/blog/uploads/avatar.gif">
  <p class="site-author-name" itemprop="name">钝悟 ◾ Dunwu</p>
  <div class="site-description" itemprop="description">钝悟的个人博客</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">144</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">122</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/dunwu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;dunwu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:forbreak@163.com" title="E-Mail → mailto:forbreak@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/dunwu/blog" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/a187f0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/a187f0/" class="post-title-link" itemprop="url">Spring 集成调度器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-11-08 16:53:27" itemprop="dateCreated datePublished" datetime="2017-11-08T16:53:27+08:00">2017-11-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-12-23 12:01:44" itemprop="dateModified" datetime="2022-12-23T12:01:44+08:00">2022-12-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">框架</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/Spring/Spring%E9%9B%86%E6%88%90/" itemprop="url" rel="index"><span itemprop="name">Spring集成</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>10k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Spring-集成调度器"><a href="#Spring-集成调度器" class="headerlink" title="Spring 集成调度器"></a>Spring 集成调度器</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>如果想在 Spring 中使用任务调度功能，除了集成调度框架 Quartz 这种方式，也可以使用 Spring 自己的调度任务框架。<br>使用 Spring 的调度框架，优点是：支持注解<code>@Scheduler</code>，可以省去大量的配置。</p>
<h2 id="实时触发调度任务"><a href="#实时触发调度任务" class="headerlink" title="实时触发调度任务"></a>实时触发调度任务</h2><h3 id="TaskScheduler-接口"><a href="#TaskScheduler-接口" class="headerlink" title="TaskScheduler 接口"></a>TaskScheduler 接口</h3><p>Spring3 引入了<code>TaskScheduler</code>接口，这个接口定义了调度任务的抽象方法。<br>TaskScheduler 接口的声明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TaskScheduler</span> &#123;</span><br><span class="line"></span><br><span class="line">    ScheduledFuture <span class="title function_">schedule</span><span class="params">(Runnable task, Trigger trigger)</span>;</span><br><span class="line"></span><br><span class="line">    ScheduledFuture <span class="title function_">schedule</span><span class="params">(Runnable task, Date startTime)</span>;</span><br><span class="line"></span><br><span class="line">    ScheduledFuture <span class="title function_">scheduleAtFixedRate</span><span class="params">(Runnable task, Date startTime, <span class="type">long</span> period)</span>;</span><br><span class="line"></span><br><span class="line">    ScheduledFuture <span class="title function_">scheduleAtFixedRate</span><span class="params">(Runnable task, <span class="type">long</span> period)</span>;</span><br><span class="line"></span><br><span class="line">    ScheduledFuture <span class="title function_">scheduleWithFixedDelay</span><span class="params">(Runnable task, Date startTime, <span class="type">long</span> delay)</span>;</span><br><span class="line"></span><br><span class="line">    ScheduledFuture <span class="title function_">scheduleWithFixedDelay</span><span class="params">(Runnable task, <span class="type">long</span> delay)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从以上方法可以看出 TaskScheduler 有两类重要参数：</p>
<ul>
<li>一个是要调度的方法，即一个实现了 Runnable 接口的线程类的 run()方法；</li>
<li>另一个就是触发条件。</li>
</ul>
<p><strong>TaskScheduler 接口的实现类</strong><br>它有三个实现类：<code>DefaultManagedTaskScheduler</code>、<code>ThreadPoolTaskScheduler</code>、<code>TimerManagerTaskScheduler</code>。<br><strong>DefaultManagedTaskScheduler</strong>：基于 JNDI 的调度器。<br><strong>TimerManagerTaskScheduler</strong>：托管<code>commonj.timers.TimerManager</code>实例的调度器。<br><strong>ThreadPoolTaskScheduler</strong>：提供线程池管理的调度器，它也实现了<code>TaskExecutor</code>接口，从而使的单一的实例可以尽可能快地异步执行。</p>
<h4 id="Trigger-接口"><a href="#Trigger-接口" class="headerlink" title="Trigger 接口"></a>Trigger 接口</h4><p>Trigger 接口抽象了触发条件的方法。<br>Trigger 接口的声明：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="symbol">Trigger</span> &#123;</span><br><span class="line">    Date nextExecutionTime(TriggerContext triggerContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Trigger 接口的实现类</strong><br><strong>CronTrigger</strong>：实现了 cron 规则的触发器类（和 Quartz 的 cron 规则相同）。<br><strong>PeriodicTrigger</strong>：实现了一个周期性规则的触发器类（例如：定义触发起始时间、间隔时间等）。</p>
<h4 id="完整范例"><a href="#完整范例" class="headerlink" title="完整范例"></a>完整范例</h4><p>实现一个调度任务的功能有以下几个关键点：<br><strong>(1) 定义调度器</strong><br>在 spring-bean.xml 中进行配置<br>使用<code>task:scheduler</code>标签定义一个大小为 10 的线程池调度器，spring 会实例化一个<code>ThreadPoolTaskScheduler</code>。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:task</span>=<span class="string">&quot;http://www.springframework.org/schema/task&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans/spring-beans-3.1.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/mvc</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/mvc/spring-mvc-3.1.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/task</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/task/spring-task-3.1.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">task:scheduler</span> <span class="attr">id</span>=<span class="string">&quot;myScheduler&quot;</span> <span class="attr">pool-size</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong><em>注：不要忘记引入 xsd：</em></strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://www.springframework.org/schema/task</span><br><span class="line">http://www.springframework.org/schema/task/spring-task-3.1.xsd</span><br></pre></td></tr></table></figure>

<p><strong>(2) 定义调度任务</strong><br>定义实现<code>Runnable</code>接口的线程类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;call DemoTask.run&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>(3) 装配调度器，并执行调度任务</strong><br>在一个<code>Controller</code>类中用<code>@Autowired</code>注解装配<code>TaskScheduler</code>。<br>然后调动 TaskScheduler 对象的 schedule 方法启动调度器，就可以执行调度任务了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.TaskScheduler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.support.CronTrigger;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/scheduler&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SchedulerController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    TaskScheduler scheduler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/start&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        scheduler.schedule(<span class="keyword">new</span> <span class="title class_">DemoTask</span>(), <span class="keyword">new</span> <span class="title class_">CronTrigger</span>(<span class="string">&quot;0/5 * * * * *&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问&#x2F;scheduler&#x2F;start 接口，启动调度器，可以看到如下日志内容：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">13</span>:<span class="number">53</span>:<span class="number">15.010</span> myScheduler-<span class="number">1</span> o<span class="selector-class">.zp</span><span class="selector-class">.notes</span><span class="selector-class">.spring</span><span class="selector-class">.scheduler</span><span class="selector-class">.DemoTask</span><span class="selector-class">.run</span> - call DemoTask<span class="selector-class">.run</span></span><br><span class="line"><span class="number">13</span>:<span class="number">53</span>:<span class="number">20.003</span> myScheduler-<span class="number">1</span> o<span class="selector-class">.zp</span><span class="selector-class">.notes</span><span class="selector-class">.spring</span><span class="selector-class">.scheduler</span><span class="selector-class">.DemoTask</span><span class="selector-class">.run</span> - call DemoTask<span class="selector-class">.run</span></span><br><span class="line"><span class="number">13</span>:<span class="number">53</span>:<span class="number">25.004</span> myScheduler-<span class="number">2</span> o<span class="selector-class">.zp</span><span class="selector-class">.notes</span><span class="selector-class">.spring</span><span class="selector-class">.scheduler</span><span class="selector-class">.DemoTask</span><span class="selector-class">.run</span> - call DemoTask<span class="selector-class">.run</span></span><br><span class="line"><span class="number">13</span>:<span class="number">53</span>:<span class="number">30.005</span> myScheduler-<span class="number">1</span> o<span class="selector-class">.zp</span><span class="selector-class">.notes</span><span class="selector-class">.spring</span><span class="selector-class">.scheduler</span><span class="selector-class">.DemoTask</span><span class="selector-class">.run</span> - call DemoTask.run</span><br></pre></td></tr></table></figure>

<h3 id="Scheduler-的使用方法"><a href="#Scheduler-的使用方法" class="headerlink" title="@Scheduler 的使用方法"></a>@Scheduler 的使用方法</h3><p>Spring 的调度器一个很大的亮点在于<code>@Scheduler</code>注解，这可以省去很多繁琐的配置。</p>
<h4 id="启动注解"><a href="#启动注解" class="headerlink" title="启动注解"></a>启动注解</h4><p>使用@Scheduler 注解先要使用<code>&lt;task:annotation-driven&gt;</code>启动注解开关。<br><strong><em>例：</em></strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:task</span>=<span class="string">&quot;http://www.springframework.org/schema/task&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans/spring-beans-3.1.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/mvc</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/mvc/spring-mvc-3.1.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/task</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/task/spring-task-3.1.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">task:annotation-driven</span> <span class="attr">executor</span>=<span class="string">&quot;myExecutor&quot;</span> <span class="attr">scheduler</span>=<span class="string">&quot;myScheduler&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">task:executor</span> <span class="attr">id</span>=<span class="string">&quot;myExecutor&quot;</span> <span class="attr">pool-size</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">task:scheduler</span> <span class="attr">id</span>=<span class="string">&quot;myScheduler&quot;</span> <span class="attr">pool-size</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Scheduler-定义触发条件"><a href="#Scheduler-定义触发条件" class="headerlink" title="@Scheduler 定义触发条件"></a>@Scheduler 定义触发条件</h4><p>例：使用<code>fixedDelay</code>指定触发条件为每 5000 毫秒执行一次。注意：必须在上一次调度成功后的 5000 秒才能执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Scheduled(fixedDelay=5000)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doSomething</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// something that should execute periodically</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例：使用<code>fixedRate</code>指定触发条件为每 5000 毫秒执行一次。注意：无论上一次调度是否成功，5000 秒后必然执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Scheduled(fixedRate=5000)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doSomething</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// something that should execute periodically</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例：使用<code>initialDelay</code>指定方法在初始化 1000 毫秒后才开始调度。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Scheduled(initialDelay=1000, fixedRate=5000)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doSomething</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// something that should execute periodically</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例：使用<code>cron</code>表达式指定触发条件为每 5000 毫秒执行一次。cron 规则和 Quartz 中的 cron 规则一致。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Scheduled(cron=&quot;*/5 * * * * MON-FRI&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doSomething</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// something that should execute on weekdays only</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="完整范例-1"><a href="#完整范例-1" class="headerlink" title="完整范例"></a>完整范例</h4><p><strong>(1) 启动注解开关，并定义调度器和执行器</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:task</span>=<span class="string">&quot;http://www.springframework.org/schema/task&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans/spring-beans-3.1.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/mvc</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/mvc/spring-mvc-3.1.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/task</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/task/spring-task-3.1.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">task:annotation-driven</span> <span class="attr">executor</span>=<span class="string">&quot;myExecutor&quot;</span> <span class="attr">scheduler</span>=<span class="string">&quot;myScheduler&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">task:executor</span> <span class="attr">id</span>=<span class="string">&quot;myExecutor&quot;</span> <span class="attr">pool-size</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">task:scheduler</span> <span class="attr">id</span>=<span class="string">&quot;myScheduler&quot;</span> <span class="attr">pool-size</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>(2) 使用@Scheduler 注解来修饰一个要调度的方法</strong><br>下面的例子展示了@Scheduler 注解定义触发条件的不同方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 使用<span class="doctag">@Scheduler</span>注解调度任务范例</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Vicotr Zhang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2016年8月31日</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScheduledMgr</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">SimpleDateFormat</span> <span class="variable">dateFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造函数中打印初始化时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ScheduledMgr</span><span class="params">()</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;Current time: &#123;&#125;&quot;</span>, dateFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * fixedDelay属性定义调度间隔时间。调度需要等待上一次调度执行完成。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(fixedDelay = 5000)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFixedDelay</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Thread.sleep(<span class="number">6000</span>);</span><br><span class="line">        logger.info(<span class="string">&quot;Current time: &#123;&#125;&quot;</span>, dateFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * fixedRate属性定义调度间隔时间。调度不等待上一次调度执行完成。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 5000)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFixedRate</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Thread.sleep(<span class="number">6000</span>);</span><br><span class="line">        logger.info(<span class="string">&quot;Current time: &#123;&#125;&quot;</span>, dateFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * initialDelay属性定义初始化后的启动延迟时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(initialDelay = 1000, fixedRate = 5000)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testInitialDelay</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Thread.sleep(<span class="number">6000</span>);</span><br><span class="line">        logger.info(<span class="string">&quot;Current time: &#123;&#125;&quot;</span>, dateFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cron属性支持使用cron表达式定义触发条件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0/5 * * * * ?&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCron</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Thread.sleep(<span class="number">6000</span>);</span><br><span class="line">        logger.info(<span class="string">&quot;Current time: &#123;&#125;&quot;</span>, dateFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我刻意设置触发方式的间隔都是 5s，且方法中均有 Thread.sleep(6000);语句。从而确保方法在下一次调度触发时间点前无法完成执行，来看一看各种方式的表现吧。<br>启动 spring 项目后，spring 会扫描<code>@Component</code>注解，然后初始化 ScheduledMgr。<br>接着，spring 会扫描<code>@Scheduler</code>注解，初始化调度器。调度器在触发条件匹配的情况下开始工作，输出日志。<br>截取部分打印日志来进行分析。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">10</span>:<span class="number">58</span>:<span class="number">46</span>.<span class="number">479</span> localhost-startStop-<span class="number">1</span> o.z.n.s.scheduler.ScheduledTasks.&lt;init&gt; - Current time: <span class="number">2016</span>-<span class="number">08</span>-<span class="number">31</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">46</span></span><br><span class="line"><span class="attribute">10</span>:<span class="number">58</span>:<span class="number">52</span>.<span class="number">523</span> myScheduler-<span class="number">1</span> o.z.n.s.scheduler.ScheduledTasks.testFixedRate - Current time: <span class="number">2016</span>-<span class="number">08</span>-<span class="number">31</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">52</span></span><br><span class="line"><span class="attribute">10</span>:<span class="number">58</span>:<span class="number">52</span>.<span class="number">523</span> myScheduler-<span class="number">3</span> o.z.n.s.scheduler.ScheduledTasks.testFixedDelay - Current time: <span class="number">2016</span>-<span class="number">08</span>-<span class="number">31</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">52</span></span><br><span class="line"><span class="attribute">10</span>:<span class="number">58</span>:<span class="number">53</span>.<span class="number">524</span> myScheduler-<span class="number">2</span> o.z.n.s.scheduler.ScheduledTasks.testInitialDelay - Current time: <span class="number">2016</span>-<span class="number">08</span>-<span class="number">31</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">53</span></span><br><span class="line"><span class="attribute">10</span>:<span class="number">58</span>:<span class="number">55</span>.<span class="number">993</span> myScheduler-<span class="number">4</span> o.z.n.s.scheduler.ScheduledTasks.testCron - Current time: <span class="number">2016</span>-<span class="number">08</span>-<span class="number">31</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">55</span></span><br><span class="line"><span class="attribute">10</span>:<span class="number">58</span>:<span class="number">58</span>.<span class="number">507</span> myScheduler-<span class="number">1</span> o.z.n.s.scheduler.ScheduledTasks.testFixedRate - Current time: <span class="number">2016</span>-<span class="number">08</span>-<span class="number">31</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">58</span></span><br><span class="line"><span class="attribute">10</span>:<span class="number">58</span>:<span class="number">59</span>.<span class="number">525</span> myScheduler-<span class="number">5</span> o.z.n.s.scheduler.ScheduledTasks.testInitialDelay - Current time: <span class="number">2016</span>-<span class="number">08</span>-<span class="number">31</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">59</span></span><br><span class="line"><span class="attribute">10</span>:<span class="number">59</span>:<span class="number">03</span>.<span class="number">536</span> myScheduler-<span class="number">3</span> o.z.n.s.scheduler.ScheduledTasks.testFixedDelay - Current time: <span class="number">2016</span>-<span class="number">08</span>-<span class="number">31</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">03</span></span><br><span class="line"><span class="attribute">10</span>:<span class="number">59</span>:<span class="number">04</span>.<span class="number">527</span> myScheduler-<span class="number">1</span> o.z.n.s.scheduler.ScheduledTasks.testFixedRate - Current time: <span class="number">2016</span>-<span class="number">08</span>-<span class="number">31</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">04</span></span><br><span class="line"><span class="attribute">10</span>:<span class="number">59</span>:<span class="number">05</span>.<span class="number">527</span> myScheduler-<span class="number">4</span> o.z.n.s.scheduler.ScheduledTasks.testInitialDelay - Current time: <span class="number">2016</span>-<span class="number">08</span>-<span class="number">31</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">05</span></span><br><span class="line"><span class="attribute">10</span>:<span class="number">59</span>:<span class="number">06</span>.<span class="number">032</span> myScheduler-<span class="number">2</span> o.z.n.s.scheduler.ScheduledTasks.testCron - Current time: <span class="number">2016</span>-<span class="number">08</span>-<span class="number">31</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">06</span></span><br><span class="line"><span class="attribute">10</span>:<span class="number">59</span>:<span class="number">10</span>.<span class="number">534</span> myScheduler-<span class="number">9</span> o.z.n.s.scheduler.ScheduledTasks.testFixedRate - Current time: <span class="number">2016</span>-<span class="number">08</span>-<span class="number">31</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">10</span></span><br><span class="line"><span class="attribute">10</span>:<span class="number">59</span>:<span class="number">11</span>.<span class="number">527</span> myScheduler-<span class="number">10</span> o.z.n.s.scheduler.ScheduledTasks.testInitialDelay - Current time: <span class="number">2016</span>-<span class="number">08</span>-<span class="number">31</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">11</span></span><br><span class="line"><span class="attribute">10</span>:<span class="number">59</span>:<span class="number">14</span>.<span class="number">524</span> myScheduler-<span class="number">4</span> o.z.n.s.scheduler.ScheduledTasks.testFixedDelay - Current time: <span class="number">2016</span>-<span class="number">08</span>-<span class="number">31</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">14</span></span><br><span class="line"><span class="attribute">10</span>:<span class="number">59</span>:<span class="number">15</span>.<span class="number">987</span> myScheduler-<span class="number">6</span> o.z.n.s.scheduler.ScheduledTasks.testCron - Current time: <span class="number">2016</span>-<span class="number">08</span>-<span class="number">31</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">15</span></span><br></pre></td></tr></table></figure>

<p>构造方法打印一次，时间点在 10:58:46。<br>testFixedRate 打印四次，每次间隔 6 秒。说明，fixedRate 不等待上一次调度执行完成，在间隔时间达到时立即执行。<br>testFixedDelay 打印三次，每次间隔大于 6 秒，且时间不固定。说明，fixedDelay 等待上一次调度执行成功后，开始计算间隔时间，再执行。<br>testInitialDelay 第一次调度时间和构造方法调度时间相隔 7 秒。说明，initialDelay 在初始化后等待指定的延迟时间才开始调度。<br>testCron 打印三次，时间间隔并非 5 秒或 6 秒，显然，cron 等待上一次调度执行成功后，开始计算间隔时间，再执行。<br>此外，可以从日志中看出，打印日志的线程最多只有 10 个，说明 2.1 中的调度器线程池配置生效。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/">Spring Framework 官方文档</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/57003e/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/57003e/" class="post-title-link" itemprop="url">Java 国际化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-11-08 14:38:26" itemprop="dateCreated datePublished" datetime="2017-11-08T14:38:26+08:00">2017-11-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-12-23 12:01:44" itemprop="dateModified" datetime="2022-12-23T12:01:44+08:00">2022-12-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaSE/" itemprop="url" rel="index"><span itemprop="name">JavaSE</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaSE/%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/" itemprop="url" rel="index"><span itemprop="name">高级特性</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>7.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Java-国际化"><a href="#Java-国际化" class="headerlink" title="Java 国际化"></a>Java 国际化</h1><h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><p>通讯的发达，使得世界各地交流越来越紧密。许多的软件产品也要面向世界上不同国家的用户。其中，语言障碍显然是产品在不同语种用户中进行推广的一个重要问题。</p>
<p>本文围绕国际化这一主题，先介绍国际标准的语言编码，然后讲解在 Java 应用中如何去实现国际化。</p>
<h3 id="语言编码、国家-x2F-地区编码"><a href="#语言编码、国家-x2F-地区编码" class="headerlink" title="语言编码、国家&#x2F;地区编码"></a>语言编码、国家&#x2F;地区编码</h3><p>做 web 开发的朋友可能多多少少接触过类似 <strong>zh-cn</strong>, <strong>en-us</strong> 这样的编码字样。</p>
<p>这些编码是用来表示指定的国家地区的语言类型的。那么，这些含有特殊含义的编码是如何产生的呢？</p>
<p><a target="_blank" rel="noopener" href="http://www.loc.gov/standards/iso639-2/php/English_list.php"><strong>ISO-639</strong></a> 标准使用编码定义了国际上常见的语言，每一种语言由两个小写字母表示。</p>
<p><a target="_blank" rel="noopener" href="https://www.iso.org/obp/ui/#iso:std:iso:3166:-2:ed-3:v1:en,fr"><strong>ISO-3166</strong></a> 标准使用编码定义了国家&#x2F;地区，每个国家&#x2F;地区由两个大写字母表示。</p>
<p>下表列举了一些常见国家、地区的语言编码：</p>
<table>
<thead>
<tr>
<th>国家&#x2F;地区</th>
<th>语言编码</th>
<th>国家&#x2F;地区</th>
<th>语言编码</th>
</tr>
</thead>
<tbody><tr>
<td>简体中文(中国)</td>
<td>zh-cn</td>
<td>繁体中文(台湾地区)</td>
<td>zh-tw</td>
</tr>
<tr>
<td>繁体中文(香港)</td>
<td>zh-hk</td>
<td>英语(香港)</td>
<td>en-hk</td>
</tr>
<tr>
<td>英语(美国)</td>
<td>en-us</td>
<td>英语(英国)</td>
<td>en-gb</td>
</tr>
<tr>
<td>英语(全球)</td>
<td>en-ww</td>
<td>英语(加拿大)</td>
<td>en-ca</td>
</tr>
<tr>
<td>英语(澳大利亚)</td>
<td>en-au</td>
<td>英语(爱尔兰)</td>
<td>en-ie</td>
</tr>
<tr>
<td>英语(芬兰)</td>
<td>en-fi</td>
<td>芬兰语(芬兰)</td>
<td>fi-fi</td>
</tr>
<tr>
<td>英语(丹麦)</td>
<td>en-dk</td>
<td>丹麦语(丹麦)</td>
<td>da-dk</td>
</tr>
<tr>
<td>英语(以色列)</td>
<td>en-il</td>
<td>希伯来语(以色列)</td>
<td>he-il</td>
</tr>
<tr>
<td>英语(南非)</td>
<td>en-za</td>
<td>英语(印度)</td>
<td>en-in</td>
</tr>
<tr>
<td>英语(挪威)</td>
<td>en-no</td>
<td>英语(新加坡)</td>
<td>en-sg</td>
</tr>
<tr>
<td>英语(新西兰)</td>
<td>en-nz</td>
<td>英语(印度尼西亚)</td>
<td>en-id</td>
</tr>
<tr>
<td>英语(菲律宾)</td>
<td>en-ph</td>
<td>英语(泰国)</td>
<td>en-th</td>
</tr>
<tr>
<td>英语(马来西亚)</td>
<td>en-my</td>
<td>英语(阿拉伯)</td>
<td>en-xa</td>
</tr>
<tr>
<td>韩文(韩国)</td>
<td>ko-kr</td>
<td>日语(日本)</td>
<td>ja-jp</td>
</tr>
<tr>
<td>荷兰语(荷兰)</td>
<td>nl-nl</td>
<td>荷兰语(比利时)</td>
<td>nl-be</td>
</tr>
<tr>
<td>葡萄牙语(葡萄牙)</td>
<td>pt-pt</td>
<td>葡萄牙语(巴西)</td>
<td>pt-br</td>
</tr>
<tr>
<td>法语(法国)</td>
<td>fr-fr</td>
<td>法语(卢森堡)</td>
<td>fr-lu</td>
</tr>
<tr>
<td>法语(瑞士)</td>
<td>fr-ch</td>
<td>法语(比利时)</td>
<td>fr-be</td>
</tr>
<tr>
<td>法语(加拿大)</td>
<td>fr-ca</td>
<td>西班牙语(拉丁美洲)</td>
<td>es-la</td>
</tr>
<tr>
<td>西班牙语(西班牙)</td>
<td>es-es</td>
<td>西班牙语(阿根廷)</td>
<td>es-ar</td>
</tr>
<tr>
<td>西班牙语(美国)</td>
<td>es-us</td>
<td>西班牙语(墨西哥)</td>
<td>es-mx</td>
</tr>
<tr>
<td>西班牙语(哥伦比亚)</td>
<td>es-co</td>
<td>西班牙语(波多黎各)</td>
<td>es-pr</td>
</tr>
<tr>
<td>德语(德国)</td>
<td>de-de</td>
<td>德语(奥地利)</td>
<td>de-at</td>
</tr>
<tr>
<td>德语(瑞士)</td>
<td>de-ch</td>
<td>俄语(俄罗斯)</td>
<td>ru-ru</td>
</tr>
<tr>
<td>意大利语(意大利)</td>
<td>it-it</td>
<td>希腊语(希腊)</td>
<td>el-gr</td>
</tr>
<tr>
<td>挪威语(挪威)</td>
<td>no-no</td>
<td>匈牙利语(匈牙利)</td>
<td>hu-hu</td>
</tr>
<tr>
<td>土耳其语(土耳其)</td>
<td>tr-tr</td>
<td>捷克语(捷克共和国)</td>
<td>cs-cz</td>
</tr>
<tr>
<td>斯洛文尼亚语</td>
<td>sl-sl</td>
<td>波兰语(波兰)</td>
<td>pl-pl</td>
</tr>
<tr>
<td>瑞典语(瑞典)</td>
<td>sv-se</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>注：由表中可以看出语言、国家&#x2F;地区编码一般都是英文单词的缩写。</strong></p>
<h3 id="字符编码"><a href="#字符编码" class="headerlink" title="字符编码"></a>字符编码</h3><p>在此处，引申一下字符编码的概念。</p>
<p><strong>是不是有了语言、国家&#x2F;地区编码，计算机就可以识别各种语言了？</strong></p>
<p>答案是否。作为程序员，相信每个人都会遇到过这样的情况：期望打印中文，结果输出的却是乱码。</p>
<p>这种情况，往往是因为字符编码的问题。</p>
<p>计算机在设计之初，并没有考虑多个国家，多种不同语言的应用场景。当时定义一种<code>ASCII</code>码，将字母、数字和其他符号编号用 7 比特的二进制数来表示。后来，计算机在世界开始普及，为了适应多种文字，出现了多种编码格式，例如中文汉字一般使用的编码格式为<code>GB2312</code>、<code>GBK</code>。</p>
<p>由此，又产生了一个问题，<strong>不同字符编码之间互相无法识别</strong>。于是，为了一统江湖，出现了 <code>unicode</code> 编码。它为每种语言的每个字符设定了统一并且唯一的二进制编码，以满足跨语言、跨平台的文本转换需求。</p>
<p>有人不禁要问，既然 <code>Unicode</code> 可以支持所有语言的字符，那还要其他字符编码做什么？</p>
<p><code>Unicode</code> 有一个缺点：为了支持所有语言的字符，所以它需要用更多位数去表示，比如 <code>ASCII</code> 表示一个英文字符只需要一个字节，而 <code>Unicode</code> 则需要两个字节。很明显，如果字符数多，这样的效率会很低。</p>
<p>为了解决这个问题，有出现了一些中间格式的字符编码：如 <code>UTF-8</code>、<code>UTF-16</code>、<code>UTF-32</code> 等（中国的程序员一般使用<strong>UTF-8</strong>编码）。</p>
<h2 id="Java-中实现国际化"><a href="#Java-中实现国际化" class="headerlink" title="Java 中实现国际化"></a>Java 中实现国际化</h2><p>国际化的实现原理很简单：</p>
<ol>
<li>先定义好不同语种的模板；</li>
<li>选择语种；</li>
<li>加载指定语种的模板。</li>
</ol>
<p>接下来，本文会按照步骤逐一讲解实现国际化的具体步骤</p>
<h3 id="定义不同语种的模板"><a href="#定义不同语种的模板" class="headerlink" title="定义不同语种的模板"></a>定义不同语种的模板</h3><p><strong>Java 中将多语言文本存储在格式为 <code>properties</code> 的资源文件中。</strong></p>
<p>它必须遵照以下的命名规范：</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">&lt;资源名&gt;</span>_<span class="attribute">&lt;语言代码&gt;</span>_<span class="attribute">&lt;国家/地区编码&gt;</span>.properties</span><br></pre></td></tr></table></figure>

<p>其中，语言编码和国家&#x2F;地区编码都是可选的。</p>
<p>注：<code>&lt;资源名&gt;.properties</code> 命名的国际化资源文件是<strong>默认的资源文件</strong>，即某个国际化类型在系统中找不到对应的资源文件，就采用这个默认的资源文件。</p>
<h4 id="定义-properties-文件"><a href="#定义-properties-文件" class="headerlink" title="定义 properties 文件"></a>定义 properties 文件</h4><p>在<code>src/main/resources/locales</code> 路径下定义名为 content 的不同语种资源文件：</p>
<p><strong>content_en_US.properties</strong></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">helloWorld</span> = HelloWorld!</span><br><span class="line"><span class="attr">time</span> = The current time is %s.</span><br></pre></td></tr></table></figure>

<p><strong>content_zh_CN.properties</strong></p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helloWorld = <span class="symbol">\u4e16</span><span class="symbol">\u754c</span><span class="symbol">\uff0c</span><span class="symbol">\u4f60</span><span class="symbol">\u597d</span><span class="symbol">\uff01</span></span><br><span class="line">time = <span class="symbol">\u5f53</span><span class="symbol">\u524d</span><span class="symbol">\u65f6</span><span class="symbol">\u95f4</span><span class="symbol">\u662f</span><span class="symbol">\u0025</span><span class="symbol">\u0073</span><span class="symbol">\u3002</span></span><br></pre></td></tr></table></figure>

<p>可以看到：几个资源文件中，定义的 Key 完全一致，只是 Value 是对应语言的字符串。</p>
<p>虽然属性值各不相同，但属性名却是相同的，这样应用程序就可以通过 Locale 对象和属性名精确调用到某个具体的属性值了。</p>
<h4 id="Unicode-转换工具"><a href="#Unicode-转换工具" class="headerlink" title="Unicode 转换工具"></a>Unicode 转换工具</h4><p>上一节中，我们定义的中文资源文件中的属性值都是以\u 开头的四位 16 进制数。其实，这表示的是一个 Unicode 编码。</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helloWorld = <span class="symbol">\u4e16</span><span class="symbol">\u754c</span><span class="symbol">\uff0c</span><span class="symbol">\u4f60</span><span class="symbol">\u597d</span><span class="symbol">\uff01</span></span><br><span class="line">time = <span class="symbol">\u5f53</span><span class="symbol">\u524d</span><span class="symbol">\u65f6</span><span class="symbol">\u95f4</span><span class="symbol">\u662f</span><span class="symbol">\u0025</span><span class="symbol">\u0073</span><span class="symbol">\u3002</span></span><br></pre></td></tr></table></figure>

<p>本文的字符编码中提到了，为了达到跨编码也正常显示的目的，有必要将非 <code>ASCII</code> 字符转为 <code>Unicode</code> 编码。上面的中文资源文件就是中文转为 <code>Unicode</code> 的结果。</p>
<p>怎么将非 <code>ASCII</code> 字符转为 <code>Unicode</code> 编码呢？</p>
<p>JDK 在 bin 目录下为我们提供了一个转换工具：<strong>native2ascii</strong>。</p>
<p>它可以将中文字符的资源文件转换为 <code>Unicode</code> 代码格式的文件，命令格式如下：</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">native2ascii <span class="comment">[-reverse]</span> <span class="comment">[-encoding 编码]</span> <span class="comment">[输入文件 <span class="comment">[输出文件]</span>]</span></span><br></pre></td></tr></table></figure>

<p>假设<strong>content_zh_CN.properties</strong> 在 <code>d:\</code> 目录。执行以下命令可以新建一个名为 <strong>content_zh_CN_new.properties</strong> 的文件，其中的内容就中文字符转为 <code>UTF-8</code> 编码格式的结果。</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">native2ascii -encoding utf-<span class="number">8</span> d:<span class="string">\content_zh_CN.properties</span> d:<span class="string">\content_zh_CN_new.properties</span></span><br></pre></td></tr></table></figure>

<h3 id="选择语种"><a href="#选择语种" class="headerlink" title="选择语种"></a>选择语种</h3><p>定义了多语言资源文件，第二步就是根据本地语种选择模板文件了。</p>
<h4 id="Locale"><a href="#Locale" class="headerlink" title="Locale"></a>Locale</h4><p>在 Java 中，一个 <code>java.util.Locale</code> 对象表示了特定的地理、政治和文化地区。需要 Locale 来执行其任务的操作称为语言环境敏感的操作，它使用 Locale 为用户量身定制本地信息。</p>
<p>它有三个构造方法</p>
<p><code>Locale(String language)</code> ：根据语言编码初始化<br><code>Locale(String language, String country)</code> ：根据语言编码、国家编码初始化<br><code>Locale(String language, String country, String variant)</code> ：根据语言编码、国家编码、变体初始化</p>
<p>此外，Locale 定义了一些常用的 Locale 常量：<code>Locale.ENGLISH</code>、<code>Locale.CHINESE</code> 等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化一个通用英语的locale.</span></span><br><span class="line"><span class="type">Locale</span> <span class="variable">locale1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Locale</span>(<span class="string">&quot;en&quot;</span>);</span><br><span class="line"><span class="comment">// 初始化一个加拿大英语的locale.</span></span><br><span class="line"><span class="type">Locale</span> <span class="variable">locale2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Locale</span>(<span class="string">&quot;en&quot;</span>, <span class="string">&quot;CA&quot;</span>);</span><br><span class="line"><span class="comment">// 初始化一个美式英语变种硅谷英语的locale</span></span><br><span class="line"><span class="type">Locale</span> <span class="variable">locale3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Locale</span>(<span class="string">&quot;en&quot;</span>, <span class="string">&quot;US&quot;</span>, <span class="string">&quot;SiliconValley&quot;</span>);</span><br><span class="line"><span class="comment">// 根据Locale常量初始化一个简体中文</span></span><br><span class="line"><span class="type">Locale</span> <span class="variable">locale4</span> <span class="operator">=</span> Locale.SIMPLIFIED_CHINESE;</span><br></pre></td></tr></table></figure>

<h3 id="加载指定语种的模板"><a href="#加载指定语种的模板" class="headerlink" title="加载指定语种的模板"></a>加载指定语种的模板</h3><h4 id="ResourceBoundle"><a href="#ResourceBoundle" class="headerlink" title="ResourceBoundle"></a>ResourceBoundle</h4><p>Java 为我们提供了用于加载国际化资源文件的工具类：<code>java.util.ResourceBoundle</code>。</p>
<p><code>ResourceBoundle</code> 提供了多个名为 <code>getBundle</code> 的静态重载方法，这些方法的作用是用来根据资源名、Locale 选择指定语种的资源文件。需要说明的是： <code>getBundle</code> 方法的第一个参数一般都是<code>baseName</code> ，这个参数表示资源文件名。</p>
<p><code>ResourceBoundle</code> 还提供了名为 <code>getString</code> 的方法，用来获取资源文件中 key 对应的 value。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"><span class="keyword">import</span> java.util.ResourceBundle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceBundleDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 根据语言+地区编码初始化</span></span><br><span class="line">        <span class="type">ResourceBundle</span> <span class="variable">rbUS</span> <span class="operator">=</span> ResourceBundle.getBundle(<span class="string">&quot;locales.content&quot;</span>, <span class="keyword">new</span> <span class="title class_">Locale</span>(<span class="string">&quot;en&quot;</span>, <span class="string">&quot;US&quot;</span>));</span><br><span class="line">        <span class="comment">// 根据Locale常量初始化</span></span><br><span class="line">        <span class="type">ResourceBundle</span> <span class="variable">rbZhCN</span> <span class="operator">=</span> ResourceBundle.getBundle(<span class="string">&quot;locales.content&quot;</span>, Locale.SIMPLIFIED_CHINESE);</span><br><span class="line">        <span class="comment">// 获取本地系统默认的Locale初始化</span></span><br><span class="line">        <span class="type">ResourceBundle</span> <span class="variable">rbDefault</span> <span class="operator">=</span> ResourceBundle.getBundle(<span class="string">&quot;locales.content&quot;</span>);</span><br><span class="line">        <span class="comment">// ResourceBundle rbDefault =ResourceBundle.getBundle(&quot;locales.content&quot;, Locale.getDefault()); // 与上行代码等价</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;en-US:&quot;</span> + rbUS.getString(<span class="string">&quot;helloWorld&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;en-US:&quot;</span> + String.format(rbUS.getString(<span class="string">&quot;time&quot;</span>), <span class="string">&quot;08:00&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;zh-CN：&quot;</span> + rbZhCN.getString(<span class="string">&quot;helloWorld&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;zh-CN：&quot;</span> + String.format(rbZhCN.getString(<span class="string">&quot;time&quot;</span>), <span class="string">&quot;08:00&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;default：&quot;</span> + rbDefault.getString(<span class="string">&quot;helloWorld&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;default：&quot;</span> + String.format(rbDefault.getString(<span class="string">&quot;time&quot;</span>), <span class="string">&quot;08:00&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="comment">// en-US:HelloWorld!</span></span><br><span class="line"><span class="comment">// en-US:The current time is 08:00.</span></span><br><span class="line"><span class="comment">// zh-CN：世界，你好！</span></span><br><span class="line"><span class="comment">// zh-CN：当前时间是08:00。</span></span><br><span class="line"><span class="comment">// default：世界，你好！</span></span><br><span class="line"><span class="comment">// default：当前时间是08:00。</span></span><br></pre></td></tr></table></figure>

<p>注：在加载资源时，如果指定的国际化资源文件不存在，它会尝试按下面的顺序加载其他的资源：本地系统默认国际化对象对应的资源 -&gt; 默认的资源。如果指定错误，Java 会提示找不到资源文件。</p>
<h2 id="支持国际化的工具类"><a href="#支持国际化的工具类" class="headerlink" title="支持国际化的工具类"></a>支持国际化的工具类</h2><p>Java 中也提供了几个支持国际化的格式化工具类。例如：<code>NumberFormat</code>、<code>DateFormat</code>、<code>MessageFormat</code></p>
<h3 id="NumberFormat"><a href="#NumberFormat" class="headerlink" title="NumberFormat"></a>NumberFormat</h3><p><code>NumberFormat</code> 是所有数字格式类的基类。它提供格式化和解析数字的接口。它也提供了决定数字所属语言类型的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.text.NumberFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NumberFormatDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">double</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">123456.78</span>;</span><br><span class="line">        <span class="type">NumberFormat</span> <span class="variable">format</span> <span class="operator">=</span> NumberFormat.getCurrencyInstance(Locale.SIMPLIFIED_CHINESE);</span><br><span class="line">        System.out.format(<span class="string">&quot;%f 的国际化（%s）结果: %s\n&quot;</span>, num, Locale.SIMPLIFIED_CHINESE, format.format(num));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="comment">// 123456.780000 的国际化（zh_CN）结果: ￥123,456.78</span></span><br></pre></td></tr></table></figure>

<h3 id="DateFormat"><a href="#DateFormat" class="headerlink" title="DateFormat"></a>DateFormat</h3><p><code>DateFormat</code> 是日期、时间格式化类的抽象类。它支持基于语言习惯的日期、时间格式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.text.DateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DateFormatDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="type">DateFormat</span> <span class="variable">df</span> <span class="operator">=</span> DateFormat.getDateInstance(DateFormat.MEDIUM, Locale.ENGLISH);</span><br><span class="line">        <span class="type">DateFormat</span> <span class="variable">df2</span> <span class="operator">=</span> DateFormat.getDateInstance(DateFormat.MEDIUM, Locale.SIMPLIFIED_CHINESE);</span><br><span class="line">        System.out.format(<span class="string">&quot;%s 的国际化（%s）结果: %s\n&quot;</span>, date, Locale.ENGLISH, df.format(date));</span><br><span class="line">        System.out.format(<span class="string">&quot;%s 的国际化（%s）结果: %s\n&quot;</span>, date, Locale.SIMPLIFIED_CHINESE, df2.format(date));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="comment">// Fri Dec 23 11:14:45 CST 2022 的国际化（en）结果: Dec 23, 2022</span></span><br><span class="line"><span class="comment">// Fri Dec 23 11:14:45 CST 2022 的国际化（zh_CN）结果: 2022-12-23</span></span><br></pre></td></tr></table></figure>

<h3 id="MessageFormat"><a href="#MessageFormat" class="headerlink" title="MessageFormat"></a>MessageFormat</h3><p><code>Messageformat</code> 提供一种与语言无关的拼接消息的方式。通过这种拼接方式，将最终呈现返回给使用者。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.text.MessageFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.GregorianCalendar;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageFormatDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">pattern1</span> <span class="operator">=</span> <span class="string">&quot;&#123;0&#125;，你好！你于 &#123;1&#125; 消费 &#123;2&#125; 元。&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">pattern2</span> <span class="operator">=</span> <span class="string">&quot;At &#123;1,time,short&#125; On &#123;1,date,long&#125;，&#123;0&#125; paid &#123;2,number, currency&#125;.&quot;</span>;</span><br><span class="line">        Object[] params = &#123; <span class="string">&quot;Jack&quot;</span>, <span class="keyword">new</span> <span class="title class_">GregorianCalendar</span>().getTime(), <span class="number">8888</span> &#125;;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg1</span> <span class="operator">=</span> MessageFormat.format(pattern1, params);</span><br><span class="line">        <span class="type">MessageFormat</span> <span class="variable">mf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageFormat</span>(pattern2, Locale.US);</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg2</span> <span class="operator">=</span> mf.format(params);</span><br><span class="line">        System.out.println(msg1);</span><br><span class="line">        System.out.println(msg2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="comment">// Jack，你好！你于 22-12-23 上午11:05 消费 8,888 元。</span></span><br><span class="line"><span class="comment">// At 11:05 AM On December 23, 2022，Jack paid $8,888.00.</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/274fd7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/274fd7/" class="post-title-link" itemprop="url">Spring集成Dubbo</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-10-27 17:30:41" itemprop="dateCreated datePublished" datetime="2017-10-27T17:30:41+08:00">2017-10-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-12-23 12:01:44" itemprop="dateModified" datetime="2022-12-23T12:01:44+08:00">2022-12-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">框架</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/Spring/Spring%E9%9B%86%E6%88%90/" itemprop="url" rel="index"><span itemprop="name">Spring集成</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Spring-集成-Dubbo"><a href="#Spring-集成-Dubbo" class="headerlink" title="Spring 集成 Dubbo"></a>Spring 集成 Dubbo</h1><h2 id="ZooKeeper"><a href="#ZooKeeper" class="headerlink" title="ZooKeeper"></a>ZooKeeper</h2><p>ZooKeeper 可以作为 Dubbo 的注册中心。</p>
<p>Dubbo 未对 Zookeeper 服务器端做任何侵入修改，只需安装原生的 Zookeeper 服务器即可，所有注册中心逻辑适配都在调用 Zookeeper 客户端时完成。</p>
<p><strong>安装</strong></p>
<p>在 <a target="_blank" rel="noopener" href="http://zookeeper.apache.org/releases.html">ZooKeeper 发布中心</a> 选择需要的版本，下载后解压到本地。</p>
<p><strong>配置</strong></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> <span class="keyword">conf</span>/zoo.cfg</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果不需要集群，<code>zoo.cfg</code> 的内容如下 <a target="_blank" rel="noopener" href="https://dubbo.gitbooks.io/dubbo-admin-book/content/install/zookeeper.html#fn_2">2</a>：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">tickTime</span><span class="operator">=</span><span class="number">2000</span></span><br><span class="line"><span class="attribute">initLimit</span><span class="operator">=</span><span class="number">10</span></span><br><span class="line"><span class="attribute">syncLimit</span><span class="operator">=</span><span class="number">5</span></span><br><span class="line"><span class="attribute">dataDir</span><span class="operator">=/</span>home/dubbo/zookeeper-<span class="number">3.3</span>.<span class="number">3</span>/data</span><br><span class="line"><span class="attribute">clientPort</span><span class="operator">=</span><span class="number">2181</span></span><br></pre></td></tr></table></figure>

<p>如果需要集群，<code>zoo.cfg</code> 的内容如下 <a target="_blank" rel="noopener" href="https://dubbo.gitbooks.io/dubbo-admin-book/content/install/zookeeper.html#fn_3">3</a>：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tickTime</span>=<span class="number">2000</span></span><br><span class="line"><span class="attr">initLimit</span>=<span class="number">10</span></span><br><span class="line"><span class="attr">syncLimit</span>=<span class="number">5</span></span><br><span class="line"><span class="attr">dataDir</span>=/home/dubbo/zookeeper-<span class="number">3.3</span>.<span class="number">3</span>/data</span><br><span class="line"><span class="attr">clientPort</span>=<span class="number">2181</span></span><br><span class="line"><span class="attr">server.1</span>=<span class="number">10.20</span>.<span class="number">153.10</span>:<span class="number">2555</span>:<span class="number">3555</span></span><br><span class="line"><span class="attr">server.2</span>=<span class="number">10.20</span>.<span class="number">153.11</span>:<span class="number">2555</span>:<span class="number">3555</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>并在 data 目录 <a target="_blank" rel="noopener" href="https://dubbo.gitbooks.io/dubbo-admin-book/content/install/zookeeper.html#fn_4">4</a> 下放置 myid 文件：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">mkdir</span> <span class="class"><span class="keyword">data</span></span></span><br><span class="line"><span class="title">vi</span> myid</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>myid 指明自己的 id，对应上面 <code>zoo.cfg</code> 中 <code>server.</code> 后的数字，第一台的内容为 1，第二台的内容为 2，内容如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>启动</strong></p>
<p>Linux 下执行 <code>bin/zkServer.sh</code> ；Windows <code>bin/zkServer.cmd</code> 启动 ZooKeeper 。</p>
<p><strong>命令行</strong></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">telnet</span> <span class="number">127.0.0.1</span> <span class="number">2181</span></span><br><span class="line"><span class="attribute">dump</span></span><br></pre></td></tr></table></figure>

<p>或者:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">echo</span> dump | nc <span class="number">127.0.0.1</span> <span class="number">2181</span></span><br></pre></td></tr></table></figure>

<p>用法:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">dubbo</span>.registry.address=zookeeper://<span class="number">10.20.153.10:2181</span>?backup=<span class="number">10.20.153.11:2181</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>或者:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:registry <span class="attribute">protocol</span>=<span class="string">&quot;zookeeper&quot;</span> <span class="attribute">address</span>=<span class="string">&quot;10.20.153.10:2181,10.20.153.11:2181&quot;</span> /&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li>Zookeeper 是 Apache Hadoop 的子项目，强度相对较好，建议生产环境使用该注册中心</li>
<li>其中 data 目录需改成你真实输出目录</li>
<li>其中 data 目录和 server 地址需改成你真实部署机器的信息</li>
<li>上面 <code>zoo.cfg</code> 中的 <code>dataDir</code></li>
<li><a target="_blank" rel="noopener" href="http://zookeeper.apache.org/doc/r3.3.3/zookeeperAdmin.html">http://zookeeper.apache.org/doc/r3.3.3/zookeeperAdmin.html</a></li>
</ol>
</blockquote>
<h2 id="Dubbo"><a href="#Dubbo" class="headerlink" title="Dubbo"></a>Dubbo</h2><p>Dubbo 采用全 Spring 配置方式，透明化接入应用，对应用没有任何 API 侵入，只需用 Spring 加载 Dubbo 的配置即可，Dubbo 基于 Spring 的 Schema 扩展进行加载。</p>
<p>如果不想使用 Spring 配置，可以通过 <a target="_blank" rel="noopener" href="https://dubbo.gitbooks.io/configuration/api.md">API 的方式</a> 进行调用。</p>
<h2 id="服务提供者"><a href="#服务提供者" class="headerlink" title="服务提供者"></a>服务提供者</h2><p>完整安装步骤，请参见：<a target="_blank" rel="noopener" href="https://dubbo.gitbooks.io/dubbo-admin-book/install/provider-demo.html">示例提供者安装</a></p>
<h3 id="定义服务接口"><a href="#定义服务接口" class="headerlink" title="定义服务接口"></a>定义服务接口</h3><p>DemoService.java <a target="_blank" rel="noopener" href="https://dubbo.gitbooks.io/dubbo-user-book/quick-start.html#fn_1">1</a>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.dubbo.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DemoService</span> &#123;</span><br><span class="line">    String <span class="title function_">sayHello</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="在服务提供方实现接口"><a href="#在服务提供方实现接口" class="headerlink" title="在服务提供方实现接口"></a>在服务提供方实现接口</h3><p>DemoServiceImpl.java <a target="_blank" rel="noopener" href="https://dubbo.gitbooks.io/dubbo-user-book/quick-start.html#fn_2">2</a>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.dubbo.demo.provider;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.demo.DemoService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">DemoService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello &quot;</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="用-Spring-配置声明暴露服务"><a href="#用-Spring-配置声明暴露服务" class="headerlink" title="用 Spring 配置声明暴露服务"></a>用 Spring 配置声明暴露服务</h3><p>provider.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:dubbo</span>=<span class="string">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd        http://code.alibabatech.com/schema/dubbo        http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 提供方应用信息，用于计算依赖关系 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">&quot;hello-world-app&quot;</span>  /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 使用multicast广播注册中心暴露服务地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;multicast://224.5.6.7:1234&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 用dubbo协议在20880端口暴露服务 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">&quot;dubbo&quot;</span> <span class="attr">port</span>=<span class="string">&quot;20880&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 声明需要暴露的服务接口 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">&quot;com.alibaba.dubbo.demo.DemoService&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;demoService&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 和本地bean一样实现服务 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;demoService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.dubbo.demo.provider.DemoServiceImpl&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果注册中心使用 ZooKeeper，可以将 dubbo:registry 改为 zookeeper:&#x2F;&#x2F;127.0.0.1:2181</p>
<h3 id="加载-Spring-配置"><a href="#加载-Spring-配置" class="headerlink" title="加载 Spring 配置"></a>加载 Spring 配置</h3><p>Provider.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Provider</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;http://10.20.160.198/wiki/display/dubbo/provider.xml&quot;</span>&#125;);</span><br><span class="line">        context.start();</span><br><span class="line">        System.in.read(); <span class="comment">// 按任意键退出</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="服务消费者"><a href="#服务消费者" class="headerlink" title="服务消费者"></a>服务消费者</h2><p>完整安装步骤，请参见：<a target="_blank" rel="noopener" href="https://dubbo.gitbooks.io/dubbo-admin-book/install/consumer-demo.html">示例消费者安装</a></p>
<h3 id="通过-Spring-配置引用远程服务"><a href="#通过-Spring-配置引用远程服务" class="headerlink" title="通过 Spring 配置引用远程服务"></a>通过 Spring 配置引用远程服务</h3><p>consumer.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:dubbo</span>=<span class="string">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd        http://code.alibabatech.com/schema/dubbo        http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 消费方应用名，用于计算依赖关系，不是匹配条件，不要与提供方一样 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">&quot;consumer-of-helloworld-app&quot;</span>  /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 使用multicast广播注册中心暴露发现服务地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;multicast://224.5.6.7:1234&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 生成远程服务代理，可以和本地bean一样使用demoService --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">&quot;demoService&quot;</span> <span class="attr">interface</span>=<span class="string">&quot;com.alibaba.dubbo.demo.DemoService&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果注册中心使用 ZooKeeper，可以将 dubbo:registry 改为 zookeeper:&#x2F;&#x2F;127.0.0.1:2181</p>
<h3 id="加载-Spring-配置，并调用远程服务"><a href="#加载-Spring-配置，并调用远程服务" class="headerlink" title="加载 Spring 配置，并调用远程服务"></a>加载 Spring 配置，并调用远程服务</h3><p>Consumer.java <a target="_blank" rel="noopener" href="https://dubbo.gitbooks.io/dubbo-user-book/quick-start.html#fn_3">3</a>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.demo.DemoService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;http://10.20.160.198/wiki/display/dubbo/consumer.xml&quot;</span>&#125;);</span><br><span class="line">        context.start();</span><br><span class="line">        <span class="type">DemoService</span> <span class="variable">demoService</span> <span class="operator">=</span> (DemoService)context.getBean(<span class="string">&quot;demoService&quot;</span>); <span class="comment">// 获取远程服务代理</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">hello</span> <span class="operator">=</span> demoService.sayHello(<span class="string">&quot;world&quot;</span>); <span class="comment">// 执行远程方法</span></span><br><span class="line">        System.out.println( hello ); <span class="comment">// 显示调用结果</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li>该接口需单独打包，在服务提供方和消费方共享</li>
<li>对服务消费方隐藏实现</li>
<li>也可以使用 IoC 注入</li>
</ol>
</blockquote>
<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>建议使用 <code>dubbo-2.3.3</code> 以上版本的 zookeeper 注册中心客户端。</p>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><p><strong>Dubbo</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/dubbo">Github</a> | <a target="_blank" rel="noopener" href="https://dubbo.gitbooks.io/dubbo-user-book/content/">用户手册</a> | <a target="_blank" rel="noopener" href="https://dubbo.gitbooks.io/dubbo-dev-book/content/">开发手册</a> | <a target="_blank" rel="noopener" href="https://dubbo.gitbooks.io/dubbo-admin-book/content/">管理员手册</a></p>
<p><strong>ZooKeeper</strong></p>
<p><a target="_blank" rel="noopener" href="http://zookeeper.apache.org/">官网</a> | <a target="_blank" rel="noopener" href="http://zookeeper.apache.org/doc/trunk/">官方文档</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/1b774c/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/1b774c/" class="post-title-link" itemprop="url">Spring 连接数据源</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-10-20 09:27:55" itemprop="dateCreated datePublished" datetime="2017-10-20T09:27:55+08:00">2017-10-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-12-23 12:01:44" itemprop="dateModified" datetime="2022-12-23T12:01:44+08:00">2022-12-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">框架</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/Spring/Spring%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">Spring数据</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>17k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>16 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Spring-连接数据源"><a href="#Spring-连接数据源" class="headerlink" title="Spring 连接数据源"></a>Spring 连接数据源</h1><blockquote>
<p>本文基于 Spring Boot 2.7.3 版本。</p>
</blockquote>
<h2 id="Spring-Boot-数据源基本配置"><a href="#Spring-Boot-数据源基本配置" class="headerlink" title="Spring Boot 数据源基本配置"></a>Spring Boot 数据源基本配置</h2><p>Spring Boot 提供了一系列 <code>spring.datasource.*</code> 配置来控制 <code>DataSource</code> 的配置。用户可以在 <code>application.properties</code> 或 <code>application.yml</code> 文件中指定数据源配置。这些配置项维护在 <a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-boot/tree/v2.7.4/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/jdbc/DataSourceProperties.java"><code>DataSourceProperties</code></a> 。</p>
<p>下面是一个最基本的 mysql 数据源配置示例（都是必填项）：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数据库访问地址</span></span><br><span class="line"><span class="attr">spring.datasource.url</span> = <span class="string">jdbc:mysql://localhost:3306/spring_tutorial?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf8</span></span><br><span class="line"><span class="comment"># 数据库驱动类，必须保证驱动类是可加载的</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span> = <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="comment"># 数据库账号</span></span><br><span class="line"><span class="attr">spring.datasource.username</span> = <span class="string">root</span></span><br><span class="line"><span class="comment"># 数据库账号密码</span></span><br><span class="line"><span class="attr">spring.datasource.password</span> = <span class="string">root</span></span><br></pre></td></tr></table></figure>

<p>需要根据实际情况，替换 <code>url</code>、<code>username</code>、<code>password</code>。</p>
<h2 id="Spring-Boot-连接嵌入式数据源"><a href="#Spring-Boot-连接嵌入式数据源" class="headerlink" title="Spring Boot 连接嵌入式数据源"></a>Spring Boot 连接嵌入式数据源</h2><p>使用内存嵌入式数据库开发应用程序通常很方便。显然，内存数据库不提供持久存储。使用者需要在应用程序启动时填充数据库，并准备在应用程序结束时丢弃数据。</p>
<p>Spring Boot 可以自动配置嵌入式数据库 <a target="_blank" rel="noopener" href="https://www.h2database.com/">H2</a>、<a target="_blank" rel="noopener" href="https://hsqldb.org/">HSQL</a> 和 <a target="_blank" rel="noopener" href="https://db.apache.org/derby/">Derby</a>。使用者无需提供任何连接 URL，只需要包含对要使用的嵌入式数据库的构建依赖项。如果类路径上有多个嵌入式数据库，需要设置 <code>spring.datasource.embedded-database-connection</code> 配置属性来控制使用哪一个。将该属性设置为 none 会禁用嵌入式数据库的自动配置。</p>
<blockquote>
<p>注意：如果在测试中使用此功能，无论使用多少应用程序上下文，整个测试套件都会重用同一个数据库。如果要确保每个上下文都有一个单独的嵌入式数据库，则应将 <code>spring.datasource.generate-unique-name</code> 设置为 true。</p>
</blockquote>
<p>下面，通过一个实例展示如何连接 H2 嵌入式数据库。</p>
<p>（1）在 pom.xml 中引入所需要的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>（2）数据源配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.jdbc-url</span> = <span class="string">jdbc:h2:mem:test</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span> = <span class="string">org.h2.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.username</span> = <span class="string">sa</span></span><br><span class="line"><span class="attr">spring.datasource.password</span> =<span class="string"></span></span><br></pre></td></tr></table></figure>

<h2 id="Spring-Boot-连接池化数据源"><a href="#Spring-Boot-连接池化数据源" class="headerlink" title="Spring Boot 连接池化数据源"></a>Spring Boot 连接池化数据源</h2><blockquote>
<p>完整示例：<a target="_blank" rel="noopener" href="https://github.com/dunwu/spring-tutorial/tree/master/codes/data/spring-boot-data-jdbc">spring-boot-data-jdbc</a></p>
</blockquote>
<p>在生产环境中，出于性能考虑，一般会通过数据库连接池连接数据源。</p>
<p>除了 <a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-boot/tree/v2.7.4/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/jdbc/DataSourceProperties.java"><code>DataSourceProperties</code></a> 中的数据源通用配置以外，Spring Boot 还支持通过使用类似<code>spring.datasource.hikari.*</code>、<code>spring.datasource.tomcat.*</code>、<code>spring.datasource.dbcp2.*</code> 和 <code>spring.datasource.oracleucp.*</code> 的前缀来配置指定的数据库连接池属性。</p>
<p>下面，就是一份 hikari 的连接池配置示例：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 连接池名称</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.pool-name</span> = <span class="string">SpringTutorialHikariPool</span></span><br><span class="line"><span class="comment"># 最大连接数，小于等于 0 会被重置为默认值 10；大于零小于 1 会被重置为 minimum-idle 的值</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.maximum-pool-size</span> = <span class="string">10</span></span><br><span class="line"><span class="comment"># 最小空闲连接，默认值10，小于 0 或大于 maximum-pool-size，都会重置为 maximum-pool-size</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.minimum-idle</span> = <span class="string">10</span></span><br><span class="line"><span class="comment"># 连接超时时间（单位：毫秒），小于 250 毫秒，会被重置为默认值 30 秒</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.connection-timeout</span> = <span class="string">60000</span></span><br><span class="line"><span class="comment"># 空闲连接超时时间，默认值 600000（10分钟），大于等于 max-lifetime 且 max-lifetime&gt;0，会被重置为0；不等于 0 且小于 10 秒，会被重置为 10 秒</span></span><br><span class="line"><span class="comment"># 只有空闲连接数大于最大连接数且空闲时间超过该值，才会被释放</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.idle-timeout</span> = <span class="string">600000</span></span><br><span class="line"><span class="comment"># 连接最大存活时间，不等于 0 且小于 30 秒，会被重置为默认值 30 分钟。该值应该比数据库所设置的超时时间短</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.max-lifetime</span> = <span class="string">540000</span></span><br></pre></td></tr></table></figure>

<p>Spring Boot 会按以下顺序检测连接池是否可用，如果可用就选择对应的池化 <code>DataSource</code>：</p>
<p>HikariCP -&gt; Tomcat pooling DataSource -&gt; DBCP2 -&gt; Oracle UCP</p>
<p>用户也可以通过 <code>spring.datasource.type</code> 来指定数据源类型。</p>
<p>此外，也可以使用 <code>DataSourceBuilder</code> 手动配置其他连接池。如果自定义 DataSource bean，则不会发生自动配置。 <code>DataSourceBuilder</code> 支持以下连接池：</p>
<ul>
<li>HikariCP</li>
<li>Tomcat pooling <code>Datasource</code></li>
<li>Commons DBCP2</li>
<li>Oracle UCP &amp; <code>OracleDataSource</code></li>
<li>Spring Framework’s <code>SimpleDriverDataSource</code></li>
<li>H2 <code>JdbcDataSource</code></li>
<li>PostgreSQL <code>PGSimpleDataSource</code></li>
<li>C3P0</li>
</ul>
<h3 id="引入-Spring-Boot-依赖"><a href="#引入-Spring-Boot-依赖" class="headerlink" title="引入 Spring Boot 依赖"></a>引入 Spring Boot 依赖</h3><p>你可以通过 Spring Boot 官方的初始化器（<a target="_blank" rel="noopener" href="https://start.spring.io/">Spring Initializr</a>）选择需要的组件来创建一个 Spring Boot 工程。或者，直接在 pom.xml 中引入所需要的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="测试单数据源连接"><a href="#测试单数据源连接" class="headerlink" title="测试单数据源连接"></a>测试单数据源连接</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.CommandLineRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringBootDataJdbcApplication</span> <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SpringBootDataJdbcApplication</span><span class="params">(JdbcTemplate jdbcTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.jdbcTemplate = jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SpringBootDataJdbcApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> jdbcTemplate.getDataSource();</span><br><span class="line"></span><br><span class="line">        Connection connection;</span><br><span class="line">        <span class="keyword">if</span> (dataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">            connection = dataSource.getConnection();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;连接数据源失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (connection != <span class="literal">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;数据源 Url: &#123;&#125;&quot;</span>, connection.getMetaData().getURL());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;连接数据源失败！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行 <code>main</code> 方法后，控制台会输出以下内容，表示数据源连接成功：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">50</span>:<span class="number">18.449</span> <span class="selector-attr">[main]</span> <span class="selector-attr">[INFO ]</span> <span class="selector-tag">i</span><span class="selector-class">.g</span><span class="selector-class">.d</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.SpringBootDataJdbcApplication</span><span class="selector-class">.run</span> - 数据源 Url: jdbc:mysql:<span class="comment">//localhost:3306/spring_tutorial?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf8</span></span><br></pre></td></tr></table></figure>

<h2 id="Spring-Boot-连接多数据源"><a href="#Spring-Boot-连接多数据源" class="headerlink" title="Spring Boot 连接多数据源"></a>Spring Boot 连接多数据源</h2><blockquote>
<p>完整示例：<a target="_blank" rel="noopener" href="https://github.com/dunwu/spring-tutorial/tree/master/codes/data/spring-boot-data-jdbc-multi-datasource">spring-boot-data-jdbc-multi-datasource</a></p>
</blockquote>
<p>Spring Boot 连接多数据源所需要的依赖并无不同，主要差异在于数据源的配置。Spring Boot 默认的数据源配置类为 <code>org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration</code>。使用者只要指定一些必要的 spring.datasource 配置，<code>DataSourceAutoConfiguration</code> 类就会自动完成剩下的数据源实例化工作。</p>
<h3 id="多数据源配置"><a href="#多数据源配置" class="headerlink" title="多数据源配置"></a>多数据源配置</h3><p>下面的示例中，自定义了一个数据源配置类，通过读取不同的 spring.datasource.xxx 来完成对于不同数据源的实例化工作。对于 JDBC 来说，最重要的，就是实例化 <code>DataSource</code> 和 <code>JdbcTemplate</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.jdbc.DataSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean(&quot;mysqlDataSource&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.mysql&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">mysqlDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean(&quot;mysqlJdbcTemplate&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> JdbcTemplate <span class="title function_">mysqlJdbcTemplate</span><span class="params">(<span class="meta">@Qualifier(&quot;mysqlDataSource&quot;)</span> DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdbcTemplate</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;h2DataSource&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.h2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">h2DataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;h2JdbcTemplate&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> JdbcTemplate <span class="title function_">h2JdbcTemplate</span><span class="params">(<span class="meta">@Qualifier(&quot;h2DataSource&quot;)</span> DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdbcTemplate</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>application.properties</code> 或 <code>application.yml</code> 配置文件中也必须以 <code>@ConfigurationProperties</code> 所指定的配置前缀进行配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数据源一：Mysql</span></span><br><span class="line"><span class="attr">spring.datasource.mysql.jdbc-url</span> = <span class="string">jdbc:mysql://localhost:3306/spring_tutorial?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false</span></span><br><span class="line"><span class="attr">spring.datasource.mysql.driver-class-name</span> = <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.mysql.username</span> = <span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.mysql.password</span> = <span class="string">root</span></span><br><span class="line"><span class="comment"># 数据源一：H2</span></span><br><span class="line"><span class="attr">spring.datasource.h2.jdbc-url</span> = <span class="string">jdbc:h2:mem:test</span></span><br><span class="line"><span class="attr">spring.datasource.h2.driver-class-name</span> = <span class="string">org.h2.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.h2.username</span> = <span class="string">sa</span></span><br><span class="line"><span class="attr">spring.datasource.h2.password</span> =<span class="string"></span></span><br></pre></td></tr></table></figure>

<h3 id="测试多数据源连接"><a href="#测试多数据源连接" class="headerlink" title="测试多数据源连接"></a>测试多数据源连接</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.CommandLineRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringBootDataJdbcMultiDataSourceApplication</span> <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(SpringBootDataJdbcMultiDataSourceApplication.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDao mysqlUserDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDao h2UserDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SpringBootDataJdbcMultiDataSourceApplication</span><span class="params">(<span class="meta">@Qualifier(&quot;mysqlUserDao&quot;)</span> UserDao mysqlUserDao,</span></span><br><span class="line"><span class="params">        <span class="meta">@Qualifier(&quot;h2UserDao&quot;)</span> UserDao h2UserDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mysqlUserDao = mysqlUserDao;</span><br><span class="line">        <span class="built_in">this</span>.h2UserDao = h2UserDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SpringBootDataJdbcMultiDataSourceApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mysqlUserDao != <span class="literal">null</span> &amp;&amp; mysqlUserDao.getJdbcTemplate() != <span class="literal">null</span>) &#123;</span><br><span class="line">            printDataSourceInfo(mysqlUserDao.getJdbcTemplate());</span><br><span class="line">            log.info(<span class="string">&quot;Connect to mysql datasource success.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Connect to mysql datasource failed!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (h2UserDao != <span class="literal">null</span>) &#123;</span><br><span class="line">            printDataSourceInfo(h2UserDao.getJdbcTemplate());</span><br><span class="line">            log.info(<span class="string">&quot;Connect to h2 datasource success.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Connect to h2 datasource failed!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 主数据源执行 JDBC SQL</span></span><br><span class="line">        mysqlUserDao.recreateTable();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 次数据源执行 JDBC SQL</span></span><br><span class="line">        h2UserDao.recreateTable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">printDataSourceInfo</span><span class="params">(JdbcTemplate jdbcTemplate)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> jdbcTemplate.getDataSource();</span><br><span class="line"></span><br><span class="line">        Connection connection;</span><br><span class="line">        <span class="keyword">if</span> (dataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">            connection = dataSource.getConnection();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Get dataSource failed!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (connection != <span class="literal">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;DataSource Url: &#123;&#125;&quot;</span>, connection.getMetaData().getURL());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Connect to datasource failed!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行 <code>main</code> 方法后，控制台会输出以下内容，表示数据源连接成功：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">16</span>:<span class="number">44.654</span> <span class="selector-attr">[main]</span> <span class="selector-attr">[INFO ]</span> <span class="selector-tag">i</span><span class="selector-class">.g</span><span class="selector-class">.d</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.SpringBootDataJdbcMultiDataSourceApplication</span><span class="selector-class">.printDataSourceInfo</span> - DataSource Url: jdbc:mysql:<span class="comment">//localhost:3306/spring_tutorial?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false</span></span><br><span class="line"><span class="number">21</span>:<span class="number">16</span>:<span class="number">44.654</span> <span class="selector-attr">[main]</span> <span class="selector-attr">[INFO ]</span> <span class="selector-tag">i</span><span class="selector-class">.g</span><span class="selector-class">.d</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.SpringBootDataJdbcMultiDataSourceApplication</span><span class="selector-class">.run</span> - Connect to mysql datasource success.</span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">16</span>:<span class="number">44.726</span> <span class="selector-attr">[main]</span> <span class="selector-attr">[INFO ]</span> <span class="selector-tag">i</span><span class="selector-class">.g</span><span class="selector-class">.d</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.SpringBootDataJdbcMultiDataSourceApplication</span><span class="selector-class">.printDataSourceInfo</span> - DataSource Url: jdbc:<span class="selector-tag">h2</span>:mem:test</span><br><span class="line"><span class="number">21</span>:<span class="number">16</span>:<span class="number">44.726</span> <span class="selector-attr">[main]</span> <span class="selector-attr">[INFO ]</span> <span class="selector-tag">i</span><span class="selector-class">.g</span><span class="selector-class">.d</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.SpringBootDataJdbcMultiDataSourceApplication</span><span class="selector-class">.run</span> - Connect to <span class="selector-tag">h2</span> datasource success.</span><br></pre></td></tr></table></figure>

<h2 id="Spring-连接数据源-1"><a href="#Spring-连接数据源-1" class="headerlink" title="Spring 连接数据源"></a>Spring 连接数据源</h2><p>如果你的项目是传统的 Spring 项目，当然也可以轻松建立数据源连接，只是需要自行设置的配置更多一些。</p>
<h3 id="引入-Spring-依赖"><a href="#引入-Spring-依赖" class="headerlink" title="引入 Spring 依赖"></a>引入 Spring 依赖</h3><p>在 pom.xml 中引入所需要的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-tx<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Spring-配置数据源"><a href="#Spring-配置数据源" class="headerlink" title="Spring 配置数据源"></a>Spring 配置数据源</h3><p>Spring 配置数据源有多种方式，下面一一列举：</p>
<h4 id="使用-JNDI-数据源"><a href="#使用-JNDI-数据源" class="headerlink" title="使用 JNDI 数据源"></a>使用 JNDI 数据源</h4><p>如果 Spring 应用部署在支持 JNDI 的 WEB 服务器上（如 WebSphere、JBoss、Tomcat 等），就可以使用 JNDI 获取数据源。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span><span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:jee</span>=<span class="string">&quot;http://www.springframework.org/schema/jee&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">            http://www.springframework.org/schema/beans/spring-beans-3.2.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/jee</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/jee/spring-jee-3.2.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 1.使用bean配置jndi数据源 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jndi.JndiObjectFactoryBean&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jndiName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;java:comp/env/jdbc/orclight&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 2.使用jee标签配置jndi数据源，与1等价，但是需要引入命名空间 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jee:jndi-lookup</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">jndi-name</span>=<span class="string">&quot; java:comp/env/jdbc/orclight&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="使用数据库连接池"><a href="#使用数据库连接池" class="headerlink" title="使用数据库连接池"></a>使用数据库连接池</h4><p>Spring 本身并没有提供数据库连接池的实现，需要自行选择合适的数据库连接池。下面是一个使用 <a target="_blank" rel="noopener" href="https://github.com/alibaba/druid">Druid</a> 作为数据库连接池的示例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置初始化大小、最小、最大 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;initialSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;minIdle&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxActive&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置获取连接等待超时的时间 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxWait&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10000&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;timeBetweenEvictionRunsMillis&quot;</span> <span class="attr">value</span>=<span class="string">&quot;60000&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置一个连接在池中最小生存的时间，单位是毫秒 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;minEvictableIdleTimeMillis&quot;</span> <span class="attr">value</span>=<span class="string">&quot;300000&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testWhileIdle&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 这里建议配置为TRUE，防止取到的连接不可用 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testOnBorrow&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testOnReturn&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 打开PSCache，并且指定每个连接上PSCache的大小 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;poolPreparedStatements&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxPoolPreparedStatementPerConnectionSize&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">value</span>=<span class="string">&quot;20&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 这里配置提交方式，默认就是TRUE，可以不用配置 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultAutoCommit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 验证连接有效与否的SQL，不同的数据配置不同 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;validationQuery&quot;</span> <span class="attr">value</span>=<span class="string">&quot;select 1 &quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;filters&quot;</span> <span class="attr">value</span>=<span class="string">&quot;stat&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="基于-JDBC-驱动的数据源"><a href="#基于-JDBC-驱动的数据源" class="headerlink" title="基于 JDBC 驱动的数据源"></a>基于 JDBC 驱动的数据源</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="SpringBoot-数据源配置"><a href="#SpringBoot-数据源配置" class="headerlink" title="SpringBoot 数据源配置"></a>SpringBoot 数据源配置</h2><blockquote>
<p>Spring Boot 数据库配置官方文档：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/data.html#data.sql">https://docs.spring.io/spring-boot/docs/current/reference/html/data.html#data.sql</a></p>
</blockquote>
<p>通过前面的实战，我们已经知道了 Spring、Spring Boot 是如何连接数据源，并通过 JDBC 方式访问数据库。</p>
<p>SpringBoot 数据源的配置方式是在 <code>application.properties</code> 或 <code>application.yml</code> 文件中指定 <code>spring.datasource.*</code> 的配置。</p>
<p>（1）数据源基本配置方式是指定 url、用户名、密码</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost/test</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">dbuser</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">dbpass</span></span><br></pre></td></tr></table></figure>

<p>（2）配置 JNDI</p>
<p>如果想要通过 JNDI 方式连接数据源，可以采用如下方式：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.jndi-name</span>=<span class="string">java:jboss/datasources/customers</span></span><br></pre></td></tr></table></figure>

<h2 id="DataSourceAutoConfiguration-类"><a href="#DataSourceAutoConfiguration-类" class="headerlink" title="DataSourceAutoConfiguration 类"></a>DataSourceAutoConfiguration 类</h2><p>显而易见，Spring Boot 的配置更加简化，那么， Spring Boot 做了哪些工作，使得接入更加便捷呢？奥秘就在于 <code>spring-boot-autoconfigure</code> jar 包，其中定义了大量的 Spring Boot 自动配置类。其中，与数据库访问相关的比较核心的配置类有：</p>
<ul>
<li><code>DataSourceAutoConfiguration</code>：数据源自动配置类</li>
<li><code>JdbcTemplateAutoConfiguration</code>：<code>JdbcTemplate</code> 自动配置类</li>
<li><code>DataSourceTransactionManagerAutoConfiguration</code>：数据源事务管理自动配置类</li>
<li><code>JndiDataSourceAutoConfiguration</code>：JNDI 数据源自动配置类</li>
<li><code>EmbeddedDataSourceConfiguration</code>：嵌入式数据库数据源自动配置类</li>
<li>等等</li>
</ul>
<p>这些自动配置类会根据各种条件控制核心类的实例化。</p>
<p><code>DataSourceAutoConfiguration</code> 是数据源自动配置类，它负责实例化 <code>DataSource</code>。</p>
<p><code>DataSourceAutoConfiguration</code> 的源码如下（省略部分代码）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfiguration(before = SqlInitializationAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123; DataSource.class, EmbeddedDatabaseType.class &#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(type = &quot;io.r2dbc.spi.ConnectionFactory&quot;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(DataSourceProperties.class)</span></span><br><span class="line"><span class="meta">@Import(DataSourcePoolMetadataProvidersConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">	<span class="meta">@Conditional(EmbeddedDatabaseCondition.class)</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean(&#123; DataSource.class, XADataSource.class &#125;)</span></span><br><span class="line">	<span class="meta">@Import(EmbeddedDataSourceConfiguration.class)</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EmbeddedDatabaseConfiguration</span> &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">	<span class="meta">@Conditional(PooledDataSourceCondition.class)</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean(&#123; DataSource.class, XADataSource.class &#125;)</span></span><br><span class="line">	<span class="meta">@Import(&#123; DataSourceConfiguration.Hikari.class, DataSourceConfiguration.Tomcat.class,</span></span><br><span class="line"><span class="meta">			DataSourceConfiguration.Dbcp2.class, DataSourceConfiguration.OracleUcp.class,</span></span><br><span class="line"><span class="meta">			DataSourceConfiguration.Generic.class, DataSourceJmxConfiguration.class &#125;)</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">PooledDataSourceConfiguration</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">PooledDataSourceCondition</span> <span class="keyword">extends</span> <span class="title class_">AnyNestedCondition</span> &#123;</span><br><span class="line">    <span class="comment">// 略</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">PooledDataSourceAvailableCondition</span> <span class="keyword">extends</span> <span class="title class_">SpringBootCondition</span> &#123;</span><br><span class="line">    <span class="comment">// 略</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EmbeddedDatabaseCondition</span> <span class="keyword">extends</span> <span class="title class_">SpringBootCondition</span> &#123;</span><br><span class="line">    <span class="comment">// 略</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DataSourceAutoConfiguration</code> 类的源码解读：</p>
<ul>
<li><code>DataSourceProperties</code> 是 <code>DataSourceAutoConfiguration</code> 的配置选项类，允许使用者通过设置选项控制 <code>DataSource</code> 初始化行为。</li>
<li><code>DataSourceAutoConfiguration</code> 通过 <code>@Import</code> 注解引入 <code>DataSourcePoolMetadataProvidersConfiguration</code> 类。</li>
<li><code>DataSourceAutoConfiguration</code> 中定义了两个内部类：嵌入式数据源配置类 <code>EmbeddedDatabaseConfiguration</code> 和 池化数据源配置类 <code>PooledDataSourceConfiguration</code>，分别标记了不同的实例化条件。<ul>
<li>当满足 <code>EmbeddedDatabaseConfiguration</code> 的示例化条件时，将引入 <code>EmbeddedDataSourceConfiguration</code> 类初始化数据源，这个类实际上是加载嵌入式数据源驱动的 ClassLoader 去进行初始化。</li>
<li>当满足 <code>PooledDataSourceConfiguration</code> 的示例化条件时，将引入 <code>DataSourceConfiguration.Hikari.class</code>、<code>DataSourceConfiguration.Tomcat.class</code>、<code>DataSourceConfiguration.Dbcp2.class</code>、<code>DataSourceConfiguration.OracleUcp.class</code>、<code>DataSourceConfiguration.Generic.class</code>、<code>DataSourceJmxConfiguration.class</code> 这些配置类，分别对应不同的数据库连接池方式。具体选用哪种数据库连接池，可以通过 <code>spring.datasource.type</code> 配置指定。其中，Hikari 是 Spring Boot 默认的数据库连接池，spring-boot-starter-data-jdbc 中内置了 Hikari 连接池驱动包。如果想要替换其他数据库连接池，前提是必须先手动引入对应的连接池驱动包。</li>
</ul>
</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://spring.io/">Spring 官网</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/index.html">Spring Framework 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/data.html">Spring Boot 官方文档</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/14/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/14/">14</a><span class="page-number current">15</span>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2015 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">钝悟 ◾ Dunwu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.5m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">22:08</span>
  </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/blog/js/comments.js"></script><script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script><script src="/blog/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/blog/js/third-party/search/local-search.js"></script>




  <script src="/blog/js/third-party/pace.js"></script>

  




<script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"dunwu","repo":"blog","client_id":"c45bc13ca1d3d3aa4836","client_secret":"1907a9f0c22087badad3938e1d7dcba9078f88ac","admin_user":"dunwu","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js","integrity":"sha256-Pmj85ojLaPOWwRtlMJwmezB/Qg8BzvJp5eTzvXaYAfA="},"path_md5":"df3612dbe1e8a41c4d8b8016252bb5bd"}</script>
<script src="/blog/js/third-party/comments/gitalk.js"></script>

</body>
</html>
